# On-demand 캐시 무효화 구현

## 개요

- **시작일**: 2026-01-07
- **상태**: 완료
- **관련 브랜치**: main

## 문제 상황

관리자 페이지에서 가넷 데이터를 수정했는데, 배포 환경에서 새로고침해도 반영되지 않음.
Firebase Firestore에는 데이터가 정상적으로 저장됨.

## 원인 분석

1. `generateStaticParams()`로 빌드 시점에 정적 페이지 생성 (SSG)
2. 페이지에 `revalidate` 설정이 없어서 빌드 후 절대 갱신되지 않음
3. 관리자 API에서 `revalidatePath()` 호출해도 ISR 미설정으로 무시됨

## 목표

- [x] 홈 페이지에 ISR 설정 추가 (`revalidate = false`)
- [x] 캐릭터 페이지에 ISR 설정 추가 (`revalidate = false`)
- [x] 관리자 API에서 전체 캐시 무효화 로직 적용

## 진행 상황

### 2026-01-07

1. 문제 원인 파악
   - `src/app/character/[name]/page.tsx`: `generateStaticParams` 있지만 `revalidate` 없음
   - `src/app/page.tsx`: `revalidate` 없음
   - 관리자 API: `revalidatePath` 호출하지만 ISR 미설정으로 동작 안 함

2. ISR 설정 추가
   - `src/app/page.tsx`에 `export const revalidate = false;` 추가
   - `src/app/character/[name]/page.tsx`에 `export const revalidate = false;` 추가

3. 관리자 API 수정
   - `clearPatchNotesDataCache` import 추가
   - 전체 캐시 무효화 로직 적용:
     ```typescript
     clearBalanceDataCache();
     clearPatchNotesDataCache();
     revalidateTag('balance-data', 'max');
     revalidateTag('patch-notes-data', 'max');
     revalidatePath('/');
     revalidatePath('/admin');
     revalidatePath('/character/[name]', 'page');
     revalidatePath('/admin/character/[name]', 'page');
     ```

4. 빌드 테스트 성공

5. 불필요한 `console.log(data)` 제거

## 해결 방법

`revalidate = false` 설정:

- 시간 기반 자동 갱신 없음 (실제로는 `unstable_cache`의 1시간 설정이 적용됨)
- `revalidatePath()` 또는 `revalidateTag()` 호출 시에만 페이지 재생성
- 크롤링 시: `triggerRevalidation()` 호출 (기존 구현)
- 관리자 수정 시: API 내에서 전체 경로 무효화

## 변경된 파일

- `src/app/page.tsx` - ISR 설정 추가
- `src/app/character/[name]/page.tsx` - ISR 설정 추가, console.log 제거
- `src/app/api/admin/characters/[name]/patches/[patchId]/route.ts` - 전체 캐시 무효화 로직

## 관련 파일

- `src/app/api/revalidate/route.ts` - 캐시 무효화 API (참고용)
- `src/lib/patch-data.ts` - 데이터 로드 및 캐시 함수
- `scripts/lib/revalidate.ts` - 크롤링용 revalidation 트리거
