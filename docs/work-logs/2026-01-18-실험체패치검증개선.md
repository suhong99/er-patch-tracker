# 실험체 패치 데이터 검증 개선

## 개요

- **시작일**: 2026-01-18
- **상태**: 진행중
- **관련 브랜치**: feature/40

## 배경

이전 작업(`2026-01-10`, `2026-01-11`)에서 실험체 패치 데이터 검증을 진행했으나, 크롤링 시 해당 실험체 영역을 벗어난 내용이 포함되는 문제가 발생했음.

## 목표

- [x] 혜진 실험체에 대한 시범 검증
- [x] 이전 작업의 문제점 분석 및 기록
- [x] 전체 실험체 검증 스크립트 작성
- [ ] 전체 85개 캐릭터 검증 실행
- [ ] 진짜 문제 데이터 수정

## 패치노트 구조

```
정규 패치:
- URL: https://playeternalreturn.com/posts/news/{patchId}
- 구조:
  <h5>실험체</h5> (또는 "실험체" 포함된 텍스트)
  <p><span><strong>캐릭터명</strong></span></p>
  <ul>
    <li>스킬명(Q/W/E/R/P)
      <ul>
        <li>스탯명 before → after</li>
      </ul>
    </li>
  </ul>
  <h5>다음섹션</h5> ← 여기서 실험체 섹션 끝

실험체 섹션 경계:
- 시작: h5에 "실험체" 또는 "Character" 포함
- 끝: 다음 h5 태그 (명칭 무관)
```

## 검증 스크립트

### 파일

- `scripts/verify-hyejin.ts` - 혜진 단일 검증 (테스트용)
- `scripts/verify-all-patches.ts` - 전체 실험체 검증

### 사용법

```bash
# 전체 실험체 검증
npx tsx scripts/verify-all-patches.ts

# 특정 캐릭터만
npx tsx scripts/verify-all-patches.ts --character=혜진

# 범위 지정 (캐릭터 이름순 정렬)
npx tsx scripts/verify-all-patches.ts --limit=6              # 처음 6개
npx tsx scripts/verify-all-patches.ts --offset=6 --limit=6   # 7~12번째
npx tsx scripts/verify-all-patches.ts --offset=12 --limit=6  # 13~18번째
```

### 결과 파일 (data/ 폴더)

| 옵션                   | 파일명                           |
| ---------------------- | -------------------------------- |
| `--limit=6`            | `verification-results-0-6.json`  |
| `--offset=6 --limit=6` | `verification-results-6-12.json` |
| `--character=혜진`     | `verification-results-혜진.json` |
| (전체)                 | `verification-results-all.json`  |

## 검증 로직

### 1. 정규화 비교

`stat + before + after`를 이어붙여서 비교:

```typescript
function normalizeChange(c) {
  // stat, before, after 이어붙이고 공백/특수문자 제거
  const combined = `${c.target}${c.stat}${c.before}${c.after}`;
  return combined
    .toLowerCase()
    .replace(/\s+/g, '')
    .replace(/[():,]/g, '');
}
```

이렇게 하면 파싱 차이(콜론 위치 등)는 무시되고 진짜 데이터 차이만 감지됨.

### 2. h5 경계 처리

- "실험체" 포함된 h5 찾기 (정확히 일치 아님)
- 다음 h5가 나오면 섹션 끝 (특정 명칭 체크 안함)

### 3. 미발견 케이스 처리

웹에서 캐릭터를 못 찾으면 `not_found`로 기록:

- 영어 페이지 (Nathapon 등)
- 특수 구조 (h5가 캐릭터 이름인 초기 패치)
- 수동 확인 필요

## 테스트 결과 (3개 캐릭터)

| 항목    | 수치                  |
| ------- | --------------------- |
| 총 검증 | 89개 (캐릭터-패치 쌍) |
| 일치    | 61개                  |
| 불일치  | 4개                   |
| 미발견  | 24개                  |

### 발견된 진짜 문제

1. **가넷 2193, 2190**: DB에 실험체와 무관한 내용 저장됨
   - "매칭 구간 세분화", "랭크 대전 사용 가능" 등
   - 이전 크롤링 시 다른 섹션 내용 혼입

2. **일부 정규화 미흡**: 특수 케이스 추가 개선 필요

### 미발견 케이스 원인

- 영어 페이지 (일부 패치)
- 초기 패치의 특수 구조
- → 수동 확인으로 처리

## 중단 시 이어서 할 작업

- [ ] 전체 85개 캐릭터 검증 실행
- [ ] 진짜 문제 데이터 수정
