# 패치 데이터 정합성 검증

## 개요

- **시작일**: 2026-01-11
- **상태**: 진행중
- **관련 브랜치**: feature/36
- **이전 작업**: 2026-01-10-전체실험체패치검증.md

## 배경

1. 85개 캐릭터의 상세 페이지에서 Firebase의 patchHistory 데이터를 보여줌
2. 이 데이터는 웹에서 크롤링해온 것
3. **크롤링/파싱 과정에서 실제 웹 내용과 다르게 저장된 경우가 있을 수 있음**

### 1월 10일 작업의 한계

- "패치 수"만 비교 (예: Firebase 44개 vs 웹 43개)
- **changes 내용**이 일치하는지는 확인 안 함

## 목표

- [ ] DB에 저장된 changes 내용과 실제 웹페이지 내용 비교
- [ ] 누락된 항목, 틀린 수치 등 불일치 발견
- [ ] 불일치 데이터 수정

## 검증 대상

```
DB: 캐릭터.patchHistory[].changes[]
웹: 해당 patchId 웹페이지의 캐릭터 변경 내용
```

### 예시

```
DB: 나딘 - 패치 3055
    changes: [{ stat: "방어력", before: "56", after: "53" }]

웹: 나딘 - 패치 3055
    실제 내용: 방어력 56→53, 체력 800→780, Q 쿨다운 10→8

    → 체력, Q 쿨다운 변경이 DB에서 누락됨!
```

## 검증 방식 구상

### 방식 A: 전체 크롤링 후 비교

1. 모든 패치노트(274개) 웹페이지 크롤링
2. 각 패치에서 캐릭터별 변경 내용 파싱
3. DB의 changes와 비교
4. 불일치 기록

- 장점: 완전한 검증
- 단점: 시간 오래 걸림, 274개 × 크롤링 시간

### 방식 B: 샘플링 검증

1. 일부 캐릭터/패치만 선택
2. 해당 건들만 상세 비교
3. 패턴 파악 후 전체 적용

- 장점: 빠름
- 단점: 일부 누락 가능

### 방식 C: 캐릭터 단위 검증

1. 각 캐릭터의 patchHistory 순회
2. 해당 patchId 웹페이지에서 캐릭터 섹션 파싱
3. changes 개수/내용 비교

## 패치노트 구조

### 정규 패치 (예: https://playeternalreturn.com/posts/news/2014)

```
h5: "실험체" (또는 "Character")
  p > span > strong: 캐릭터명
  p: 변경 내용 (스킬명, before → after)
```

### 핫픽스 (예: https://playeternalreturn.com/posts/news/3270)

- 실험체 밸런싱이 있을 수도 없을 수도 있음
- 있으면 정규 패치와 동일한 구조

## 진행 상황

### 2026-01-11

- 작업 방향 재정립
- 검증 스크립트 작성 (`scripts/verify-patch-integrity.ts`)
- 전체 검증 실행 완료
- **누락 케이스 발견**: 95건 패치
- 수정 스크립트 작성 (`scripts/fix-missing-changes.ts`)
- **DB 수정 완료**: 95건 패치, **202개 changes 추가**

## 검증 결과

### 요약

| 항목                  | 수치                     |
| --------------------- | ------------------------ |
| 총 검증               | 2,584개 (캐릭터-패치 쌍) |
| 누락 케이스 (웹 > DB) | 95건                     |
| 총 누락 changes       | 약 174개                 |

### 주요 누락 패치 (5개 이상 누락)

| 캐릭터   | 패치 | 버전  | 누락 수 |
| -------- | ---- | ----- | ------- |
| 피오라   | 1727 | 1.15  | 9개     |
| 제니     | 1765 | 1.16  | 8개     |
| 바바라   | 2179 | 1.30  | 7개     |
| 루크     | 1328 | 1.1   | 7개     |
| 츠바메   | 1920 | 1.22  | 7개     |
| 루크     | 2364 | 1.36  | 6개     |
| 니아     | 2713 | 1.47a | 5개     |
| 이슈트반 | 2636 | 1.44c | 5개     |
| 리오     | 2828 | 8.0   | 5개     |

### 결과 파일

- `scripts/integrity-results.json` - 전체 검증 결과 (JSON)

## 수정 결과

| 항목                  | 수치      |
| --------------------- | --------- |
| 수정된 패치           | 58개      |
| 수정된 캐릭터-패치 쌍 | 95건      |
| 추가된 changes        | **202개** |

### 주요 수정 내역

| 캐릭터 | 패치 | 추가된 changes |
| ------ | ---- | -------------- |
| 피오라 | 1727 | +9개           |
| 제니   | 1765 | +8개           |
| 바바라 | 2179 | +7개           |
| 루크   | 1328 | +7개           |
| 츠바메 | 1920 | +7개           |
| 루크   | 2364 | +6개           |

## 상태

- **상태**: 완료
- **결과**: 95건 패치에서 202개 누락 changes DB 반영 완료
