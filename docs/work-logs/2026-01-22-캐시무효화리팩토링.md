# 캐시 무효화 로직 리팩토링

## 개요

- **브랜치**: feature/45
- **날짜**: 2026-01-22
- **상태**: 1단계 완료

## 목표

1. 캐시 초기화 로직을 공용 함수로 추출하여 재사용성 향상
2. `verifyAdmin` 함수도 공용 모듈로 추출
3. 향후 패치노트 검색/수정 기능 추가 시 활용할 수 있는 기반 마련

## 현재 상황

### 중복 코드 위치

| 파일                                                               | 함수          | 중복 코드                |
| ------------------------------------------------------------------ | ------------- | ------------------------ |
| `src/app/api/admin/characters/[name]/patches/route.ts`             | POST          | verifyAdmin, 캐시 무효화 |
| `src/app/api/admin/characters/[name]/patches/[patchId]/route.ts`   | PATCH, DELETE | verifyAdmin, 캐시 무효화 |
| `src/app/api/admin/characters/[name]/recalculate-streaks/route.ts` | POST          | verifyAdmin, 캐시 무효화 |

### 중복 캐시 무효화 코드

```typescript
revalidateTag('balance-data', 'max');
revalidateTag('patch-notes-data', 'max');
revalidatePath('/');
revalidatePath('/admin');
revalidatePath('/character/[name]', 'page');
revalidatePath('/admin/character/[name]', 'page');
```

## 실행 계획

### 1단계: 공용 함수 파일 생성 ✅

- [x] `src/lib/admin-utils.ts` 생성
- [x] `verifyAdmin()` 함수 추출
- [x] `invalidateBalanceCache()` 함수 추출
- [x] `invalidateCharacterCache()` 함수 추가 (특정 캐릭터 페이지만 무효화)

### 2단계: 기존 API 라우트 리팩토링 ✅

- [x] `patches/route.ts` 수정
- [x] `patches/[patchId]/route.ts` 수정
- [x] `recalculate-streaks/route.ts` 수정

### 3단계: 테스트 ✅

- [x] 빌드 확인 (성공)
- [x] 타입 에러 없는지 확인 (성공)

## 변경 파일

- `src/lib/admin-utils.ts` (신규)
- `src/app/api/admin/characters/[name]/patches/route.ts`
- `src/app/api/admin/characters/[name]/patches/[patchId]/route.ts`
- `src/app/api/admin/characters/[name]/recalculate-streaks/route.ts`

## 중단 시 이어서 할 작업

(작업 중단 시 여기에 기록)
